---
- name: Corriger la configuration Wazuh
  hosts: all
  become: yes
  vars:
    wazuh_manager_ip: "192.168.111.74"

  tasks:
    - name: Arrêter le service Wazuh
      systemd:
        name: wazuh-agent
        state: stopped
      ignore_errors: yes

    - name: Sauvegarder la configuration actuelle
      copy:
        src: /var/ossec/etc/ossec.conf
        dest: /var/ossec/etc/ossec.conf.backup
        remote_src: yes
        backup: yes

    - name: Afficher la configuration actuelle (pour debug)
      command: cat /var/ossec/etc/ossec.conf
      register: current_config
      changed_when: false

    - name: Debug - Afficher la config actuelle
      debug:
        msg: "Configuration actuelle : {{ current_config.stdout }}"

    - name: Corriger la configuration - Méthode complète
      blockinfile:
        path: /var/ossec/etc/ossec.conf
        marker: "# {mark} WAZUH MANAGER CONFIGURATION"
        block: |
          <ossec_config>
            <client>
              <server>
                <address>{{ wazuh_manager_ip }}</address>
                <port>1514</port>
                <protocol>tcp</protocol>
              </server>
              <config-profile>ubuntu, debian</config-profile>
              <notify_time>10</notify_time>
              <time-reconnect>60</time-reconnect>
              <auto_restart>yes</auto_restart>
            </client>
          </ossec_config>
        backup: yes

    - name: Vérifier la syntaxe de la configuration
      command: /var/ossec/bin/wazuh-agentd -t
      register: config_test
      changed_when: false

    - name: Afficher le résultat du test de configuration
      debug:
        msg: "Test configuration : {{ config_test.stdout }}"

    - name: Démarrer le service Wazuh
      systemd:
        name: wazuh-agent
        state: started
        enabled: yes

    - name: Vérifier le statut du service
      systemd:
        name: wazuh-agent
        state: started
      register: service_status

    - name: Afficher le résultat final
      debug:
        msg: "Service Wazuh status: {{ service_status.state }}"
