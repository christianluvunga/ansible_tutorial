---
- name: Installer Wazuh sur toutes les machines manquantes
  hosts: "10.11.131.44,10.11.131.45,10.11.131.66,10.11.131.239"
  become: yes
  vars:
    wazuh_manager_ip: "192.168.111.74"

  tasks:
    - name: Détecter la distribution
      setup:
        gather_subset:
          - os_family

    - name: Afficher la distribution détectée
      debug:
        msg: "Installation sur {{ inventory_hostname }} - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Installer Wazuh Agent sur Debian/Ubuntu
      block:
        - name: Télécharger le package DEB
          get_url:
            url: https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.14.0-1_amd64.deb
            dest: /tmp/wazuh-agent_4.14.0-1_amd64.deb
            mode: '0644'

        - name: Installer le package avec variable d'environnement
          shell: |
            export WAZUH_MANAGER='{{ wazuh_manager_ip }}'
            dpkg -i /tmp/wazuh-agent_4.14.0-1_amd64.deb
          args:
            executable: /bin/bash

      when: ansible_os_family == "Debian"

    - name: Installer Wazuh Agent sur RedHat/CentOS/AlmaLinux
      block:
        - name: Télécharger le package RPM
          get_url:
            url: https://packages.wazuh.com/4.x/yum/wazuh-agent-4.14.0-1.x86_64.rpm
            dest: /tmp/wazuh-agent-4.14.0-1.x86_64.rpm
            mode: '0644'

        - name: Installer le package RPM
          yum:
            name: /tmp/wazuh-agent-4.14.0-1.x86_64.rpm
            state: present

      when: ansible_os_family == "RedHat"

    - name: Vérifier que Wazuh est installé
      stat:
        path: /var/ossec/etc/ossec.conf
      register: wazuh_installed

    - name: Afficher le résultat de l'installation
      debug:
        msg: "Wazuh installé sur {{ inventory_hostname }} : {{ wazuh_installed.stat.exists }}"

    - name: Configurer le manager Wazuh (si installation réussie)
      block:
        - name: Créer la configuration Wazuh complète
          copy:
            content: |
              <!-- Wazuh Agent Configuration -->
              <ossec_config>
                <!-- Client section -->
                <client>
                  <server>
                    <address>{{ wazuh_manager_ip }}</address>
                    <port>1514</port>
                    <protocol>tcp</protocol>
                  </server>
                  <config-profile>linux</config-profile>
                  <notify_time>10</notify_time>
                  <time-reconnect>60</time-reconnect>
                  <auto_restart>yes</auto_restart>
                </client>

                <!-- Policy monitoring -->
                <syscheck>
                  <disabled>no</disabled>
                  <frequency>43200</frequency>
                  <scan_on_start>yes</scan_on_start>
                  <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
                  <directories check_all="yes">/bin,/sbin</directories>
                  <ignore>/etc/mtab</ignore>
                  <ignore>/etc/hosts.deny</ignore>
                  <ignore>/etc/random-seed</ignore>
                  <ignore>/etc/adjtime</ignore>
                </syscheck>

                <!-- Rootcheck -->
                <rootcheck>
                  <disabled>no</disabled>
                  <check_unixaudit>yes</check_unixaudit>
                  <check_files>yes</check_files>
                  <check_trojans>yes</check_trojans>
                  <check_dev>yes</check_dev>
                  <check_sys>yes</check_sys>
                  <check_pids>yes</check_pids>
                  <check_ports>yes</check_ports>
                  <check_if>yes</check_if>
                  <frequency>43200</frequency>
                </rootcheck>

                <!-- Active response -->
                <active-response>
                  <disabled>no</disabled>
                </active-response>

                <!-- Logs to analyze -->
                <localfile>
                  <log_format>syslog</log_format>
                  <location>/var/log/messages</location>
                </localfile>

                <localfile>
                  <log_format>syslog</log_format>
                  <location>/var/log/secure</location>
                </localfile>

              </ossec_config>
            dest: /var/ossec/etc/ossec.conf
            mode: '0644'
          when: wazuh_installed.stat.exists

        - name: Vérifier la syntaxe de la configuration
          command: /var/ossec/bin/wazuh-agentd -t
          register: config_test
          when: wazuh_installed.stat.exists
          changed_when: false

        - name: Afficher le résultat du test de configuration
          debug:
            msg: "Test configuration sur {{ inventory_hostname }} : {{ config_test.stdout }}"
          when: wazuh_installed.stat.exists

      when: wazuh_installed.stat.exists

    - name: Démarrer et activer le service Wazuh
      systemd:
        name: wazuh-agent
        state: started
        enabled: yes
      when: wazuh_installed.stat.exists

    - name: Nettoyer les packages temporaires
      file:
        path: "/tmp/wazuh-agent-*"
        state: absent

    - name: Vérification finale
      systemd:
        name: wazuh-agent
        state: started
      register: final_status
      when: wazuh_installed.stat.exists

    - name: Afficher le statut final
      debug:
        msg: "✅ Wazuh agent installé et démarré sur {{ inventory_hostname }}"
      when: final_status.state == "started"
