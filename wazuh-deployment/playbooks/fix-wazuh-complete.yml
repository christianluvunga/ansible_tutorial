---
- name: Réécrire complètement la configuration Wazuh
  hosts: all
  become: yes
  vars:
    wazuh_manager_ip: "192.168.111.74"

  tasks:
    - name: Arrêter le service Wazuh
      systemd:
        name: wazuh-agent
        state: stopped
      ignore_errors: yes

    - name: Créer une configuration Wazuh complète
      copy:
        content: |
          <!-- Wazuh Agent Configuration -->
          <ossec_config>
            <!-- Client section -->
            <client>
              <server>
                <address>{{ wazuh_manager_ip }}</address>
                <port>1514</port>
                <protocol>tcp</protocol>
              </server>
              <config-profile>ubuntu, debian</config-profile>
              <notify_time>10</notify_time>
              <time-reconnect>60</time-reconnect>
              <auto_restart>yes</auto_restart>
            </client>

            <!-- Policy monitoring -->
            <syscheck>
              <disabled>no</disabled>
              <frequency>43200</frequency>
              
              <scan_on_start>yes</scan_on_start>
              
              <!-- Directories to check (perform add, delete, modify) -->
              <directories check_all="yes">/etc,/usr/bin,/usr/sbin</directories>
              <directories check_all="yes">/bin,/sbin</directories>
              
              <!-- Files/directories to ignore -->
              <ignore>/etc/mtab</ignore>
              <ignore>/etc/hosts.deny</ignore>
              <ignore>/etc/mail/statistics</ignore>
              <ignore>/etc/random-seed</ignore>
              <ignore>/etc/random.seed</ignore>
              <ignore>/etc/adjtime</ignore>
              <ignore>/etc/httpd/logs</ignore>
              <ignore>/etc/utmpx</ignore>
              <ignore>/etc/wtmpx</ignore>
              <ignore>/etc/cups/certs</ignore>
              <ignore>/etc/dumpdates</ignore>
              <ignore>/etc/svc/volatile</ignore>
            </syscheck>

            <!-- Rootcheck -->
            <rootcheck>
              <disabled>no</disabled>
              <check_unixaudit>yes</check_unixaudit>
              <check_files>yes</check_files>
              <check_trojans>yes</check_trojans>
              <check_dev>yes</check_dev>
              <check_sys>yes</check_sys>
              <check_pids>yes</check_pids>
              <check_ports>yes</check_ports>
              <check_if>yes</check_if>
              <frequency>43200</frequency>
            </rootcheck>

            <!-- Active response -->
            <active-response>
              <disabled>no</disabled>
            </active-response>

            <!-- Logs to analyze -->
            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/syslog</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/auth.log</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/dpkg.log</location>
            </localfile>

          </ossec_config>
        dest: /var/ossec/etc/ossec.conf
        backup: yes
        mode: '0644'

    - name: Vérifier la syntaxe de la configuration
      command: /var/ossec/bin/wazuh-agentd -t
      register: config_test
      changed_when: false

    - name: Afficher le résultat du test
      debug:
        msg: "Test de configuration: {{ config_test.stdout }}"

    - name: Démarrer le service Wazuh
      systemd:
        name: wazuh-agent
        state: started
        enabled: yes

    - name: Vérifier que le service fonctionne
      systemd:
        name: wazuh-agent
        state: started
      register: final_status

    - name: Afficher le statut final
      debug:
        msg: "✅ Wazuh agent est maintenant démarré et configuré avec le manager {{ wazuh_manager_ip }}"
      when: final_status.state == "started"
