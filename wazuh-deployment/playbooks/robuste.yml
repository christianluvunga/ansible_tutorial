---
- name: DÃ©ploiement Wazuh Final - Version fonctionnelle
  hosts: all
  become: yes
  vars:
    wazuh_manager_ip: "192.168.111.74"
    
  tasks:
    # PHASE 1: PRÃ‰PARATION - INSTALLER LES OUTILS MANQUANTS
    - name: Installer les outils de diagnostic manquants (Debian/Ubuntu)
      apt:
        name:
          - net-tools
          - procps
          - debianutils
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Installer les outils de diagnostic manquants (RedHat/CentOS/AlmaLinux)
      yum:
        name:
          - net-tools
          - procps-ng
          - which
        state: present
      when: ansible_os_family == "RedHat"

    # PHASE 2: DIAGNOSTIC
    - name: VÃ©rifier l'Ã©tat actuel de Wazuh
      block:
        - name: VÃ©rifier si le binaire Wazuh existe
          stat:
            path: /var/ossec/bin/wazuh-agentd
          register: wazuh_binary

        - name: VÃ©rifier le statut du service Wazuh
          systemd:
            name: wazuh-agent
          register: service_status
          ignore_errors: yes
          changed_when: false

        - name: VÃ©rifier si la configuration existe
          stat:
            path: /var/ossec/etc/ossec.conf
          register: config_exists

      rescue:
        - name: En cas d'erreur, considÃ©rer comme non installÃ©
          set_fact:
            wazuh_binary: {"stat": {"exists": false}}
            service_status: {"status": {"ActiveState": "inactive"}}
            config_exists: {"stat": {"exists": false}}

    - name: DÃ©terminer l'Ã©tat de la machine
      set_fact:
        machine_state: >
          {% if wazuh_binary.stat.exists and service_status.status.ActiveState == "active" and config_exists.stat.exists %}
          "healthy"
          {% elif wazuh_binary.stat.exists and config_exists.stat.exists %}
          "installed_but_issue" 
          {% elif wazuh_binary.stat.exists %}
          "installed_no_config"
          {% else %}
          "not_installed"
          {% endif %}

    - name: Afficher le diagnostic
      debug:
        msg: |
          {{ inventory_hostname }} ({{ ansible_distribution }}) - Ã‰tat: {{ machine_state }}
          - Binaire Wazuh: {{ wazuh_binary.stat.exists }}
          - Service: {{ service_status.status.ActiveState }}
          - Configuration: {{ config_exists.stat.exists }}

    # PHASE 3: INSTALLATION
    - name: Installer Wazuh sur les machines non installÃ©es (Debian/Ubuntu)
      block:
        - name: Installer les dÃ©pendances pour Debian
          apt:
            name:
              - lsb-release
              - curl
            state: present
            update_cache: yes

        - name: TÃ©lÃ©charger le package DEB
          get_url:
            url: https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.14.0-1_amd64.deb
            dest: /tmp/wazuh-agent_4.14.0-1_amd64.deb
            mode: '0644'

        - name: Installer le package avec variable d'environnement
          shell: |
            export WAZUH_MANAGER='{{ wazuh_manager_ip }}'
            dpkg -i /tmp/wazuh-agent_4.14.0-1_amd64.deb || (apt-get update && apt-get install -f -y)
          args:
            executable: /bin/bash

      when: 
        - machine_state == "not_installed"
        - ansible_os_family == "Debian"

    - name: Installer Wazuh sur les machines non installÃ©es (RedHat/CentOS/AlmaLinux)
      block:
        - name: Importer la clÃ© GPG Wazuh
          rpm_key:
            key: https://packages.wazuh.com/key/GPG-KEY-WAZUH
            state: present

        - name: TÃ©lÃ©charger et installer le package RPM
          yum:
            name: https://packages.wazuh.com/4.x/yum/wazuh-agent-4.14.0-1.x86_64.rpm
            state: present

      when: 
        - machine_state == "not_installed" 
        - ansible_os_family == "RedHat"

    # PHASE 4: CONFIGURATION
    - name: Appliquer la configuration Wazuh complÃ¨te
      block:
        - name: ArrÃªter le service Wazuh pour reconfiguration
          systemd:
            name: wazuh-agent
            state: stopped
          ignore_errors: yes
          when: machine_state != "not_installed"

        - name: CrÃ©er la configuration Wazuh complÃ¨te
          copy:
            content: |
              <ossec_config>
                <client>
                  <server>
                    <address>{{ wazuh_manager_ip }}</address>
                    <port>1514</port>
                    <protocol>tcp</protocol>
                  </server>
                  <config-profile>
                    {% if ansible_distribution == "Debian" or ansible_distribution == "Ubuntu" %}debian,ubuntu
                    {% elif ansible_distribution == "AlmaLinux" or ansible_distribution == "CentOS" %}almalinux,centos,rhel  
                    {% else %}linux{% endif %}
                  </config-profile>
                  <notify_time>10</notify_time>
                  <time-reconnect>60</time-reconnect>
                  <auto_restart>yes</auto_restart>
                </client>
                <syscheck>
                  <disabled>no</disabled>
                  <frequency>43200</frequency>
                </syscheck>
                <rootcheck>
                  <disabled>no</disabled>
                </rootcheck>
                <active-response>
                  <disabled>no</disabled>
                </active-response>
              </ossec_config>
            dest: /var/ossec/etc/ossec.conf
            mode: '0644'
            backup: yes

        - name: VÃ©rifier la syntaxe de la configuration
          command: /var/ossec/bin/wazuh-agentd -t
          register: config_test
          changed_when: false

        - name: Afficher le rÃ©sultat du test de configuration
          debug:
            msg: "Test configuration {{ inventory_hostname }} : OK"

      when: machine_state != "healthy"

    # PHASE 5: DÃ‰MARRAGE
    - name: DÃ©marrer et activer le service Wazuh
      systemd:
        name: wazuh-agent
        state: started
        enabled: yes

    - name: Forcer le redÃ©marrage si nÃ©cessaire
      systemd:
        name: wazuh-agent
        state: restarted
      when: machine_state != "healthy"

    # PHASE 6: VÃ‰RIFICATION FINALE - VERSION SIMPLIFIÃ‰E SANS BLOC COMPLEXE
    - name: VÃ©rifier le statut final du service
      systemd:
        name: wazuh-agent
        state: started
      register: final_check

    - name: VÃ©rifier la connexion (mÃ©thode simple)
      shell: |
        if netstat -tunp 2>/dev/null | grep -q 1514; then
          echo "connexion_active_netstat"
        elif ss -tunp 2>/dev/null | grep -q 1514; then
          echo "connexion_active_ss"
        else
          echo "connexion_non_detectee"
        fi
      args:
        executable: /bin/bash
      register: connection_check
      changed_when: false
      ignore_errors: yes

    - name: Compter les processus Wazuh
      shell: |
        ps aux | grep -v grep | grep wazuh | wc -l
      args:
        executable: /bin/bash
      register: wazuh_processes
      changed_when: false
      ignore_errors: yes

    - name: Afficher le rÃ©sultat final
      debug:
        msg: |
          ðŸŽ¯ {{ inventory_hostname }} - DÃ‰PLOIEMENT TERMINÃ‰
          âœ… Service: {{ final_check.state }}
          ðŸ”Œ Connexion: {{ connection_check.stdout | default('non_verifiee') }}
          ðŸ“Š Processus Wazuh: {{ wazuh_processes.stdout | default('non_verifie') }}

    # PHASE 7: NETTOYAGE
    - name: Nettoyer les packages temporaires
      file:
        path: "/tmp/wazuh-agent-*"
        state: absent
      ignore_errors: yes

    - name: RÃ©sumÃ© global
      debug:
        msg: |
          ðŸŽ‰ DÃ‰PLOIEMENT WAZUH RÃ‰USSI !
          ðŸ“Š {{ groups['all'] | length }} machines configurÃ©es
          ðŸŽ¯ Manager: {{ wazuh_manager_ip }}
          âœ… VÃ©rifiez l'interface: https://{{ wazuh_manager_ip }}
      run_once: yes
