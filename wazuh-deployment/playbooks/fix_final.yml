---
- name: D√©ploiement Wazuh Agent - Version Compl√®te et Corrig√©e
  hosts: all
  become: yes
  vars:
    wazuh_manager_ip: "192.168.111.98"
    wazuh_version: "4.14.0-1"

  tasks:
    # PHASE 1: V√âRIFICATION PR√âALABLE
    - name: V√©rifier si Wazuh est d√©j√† install√©
      stat:
        path: /var/ossec/bin/wazuh-agentd
      register: wazuh_installed_check
      ignore_errors: yes

    - name: D√©terminer si installation est n√©cessaire
      set_fact:
        installation_needed: "{{ not wazuh_installed_check.stat.exists }}"

    - name: Afficher l'√©tat avant installation
      debug:
        msg: |
          {{ inventory_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})
          - Installation n√©cessaire: {{ installation_needed }}
          - Binaire pr√©sent: {{ wazuh_installed_check.stat.exists | default(false) }}

    # PHASE 2: INSTALLATION (uniquement si n√©cessaire)
    - name: Installer Wazuh Agent sur Debian/Ubuntu
      block:
        - name: Installer curl (d√©pendance)
          apt:
            name: curl
            state: present
            update_cache: yes

        - name: T√©l√©charger le package Wazuh
          get_url:
            url: "https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_{{ wazuh_version }}_amd64.deb"
            dest: "/tmp/wazuh-agent_{{ wazuh_version }}_amd64.deb"
            mode: '0644'

        - name: Installer le package avec variable d'environnement
          shell: |
            export WAZUH_MANAGER='{{ wazuh_manager_ip }}'
            dpkg -i /tmp/wazuh-agent_{{ wazuh_version }}_amd64.deb || (apt-get update && apt-get install -f -y)
          args:
            executable: /bin/bash

      when: 
        - installation_needed
        - ansible_os_family == "Debian"
      tags: installation

    - name: Installer Wazuh Agent sur RedHat/AlmaLinux
      block:
        - name: Installer curl (d√©pendance)
          yum:
            name: curl
            state: present

        - name: T√©l√©charger la cl√© GPG
          get_url:
            url: https://packages.wazuh.com/key/GPG-KEY-WAZUH
            dest: /etc/pki/rpm-gpg/RPM-GPG-KEY-WAZUH
            mode: '0644'

        - name: Importer la cl√© GPG
          rpm_key:
            key: /etc/pki/rpm-gpg/RPM-GPG-KEY-WAZUH
            state: present

        - name: Installer le package Wazuh
          yum:
            name: "https://packages.wazuh.com/4.x/yum/wazuh-agent-{{ wazuh_version }}.x86_64.rpm"
            state: present

      when: 
        - installation_needed
        - ansible_os_family == "RedHat"
      tags: installation

    # PHASE 3: V√âRIFICATION APR√àS INSTALLATION
    - name: V√©rifier l'installation
      block:
        - name: V√©rifier le binaire apr√®s installation
          stat:
            path: /var/ossec/bin/wazuh-agentd
          register: check_installation
          ignore_errors: yes

        - name: Afficher le r√©sultat de l'installation
          debug:
            msg: |
              {{ inventory_hostname }} - R√©sultat installation:
              - Binaire install√©: {{ check_installation.stat.exists | default(false) }}
              - Chemin: /var/ossec/bin/wazuh-agentd
      when: installation_needed
      tags: verification

    # PHASE 4: RECONFIGURATION SYSTEMD
    - name: Recharger systemd (toujours)
      systemd:
        daemon_reload: yes
      tags: configuration

    # PHASE 5: CONFIGURATION WAZUH (toujours appliquer)
    - name: Cr√©er le r√©pertoire de configuration si n√©cessaire
      file:
        path: /var/ossec/etc
        state: directory
        mode: '0755'
      tags: configuration

    - name: Configurer l'agent Wazuh
      copy:
        content: |
          <ossec_config>
            <client>
              <server>
                <address>{{ wazuh_manager_ip }}</address>
                <port>1514</port>
                <protocol>tcp</protocol>
              </server>
              <config-profile>
                {% if ansible_distribution == "Debian" or ansible_distribution == "Ubuntu" %}debian,ubuntu
                {% elif ansible_distribution == "AlmaLinux" or ansible_distribution == "CentOS" %}almalinux,centos,rhel  
                {% else %}linux{% endif %}
              </config-profile>
              <notify_time>10</notify_time>
              <time-reconnect>60</time-reconnect>
              <auto_restart>yes</auto_restart>
            </client>
            <syscheck>
              <disabled>no</disabled>
              <frequency>43200</frequency>
              <scan_on_start>yes</scan_on_start>
              <auto_ignore>no</auto_ignore>
            </syscheck>
            <rootcheck>
              <disabled>no</disabled>
              <check_unixaudit>yes</check_unixaudit>
            </rootcheck>
            <active-response>
              <disabled>no</disabled>
            </active-response>
          </ossec_config>
        dest: /var/ossec/etc/ossec.conf
        mode: '0644'
        backup: yes
      tags: configuration

    # PHASE 6: V√âRIFICATION DE LA CONFIGURATION
    - name: V√©rifier la syntaxe de la configuration
      command: /var/ossec/bin/wazuh-agentd -t
      register: config_test
      changed_when: false
      ignore_errors: yes
      tags: verification

    - name: Afficher le r√©sultat du test de configuration
      debug:
        msg: "{{ inventory_hostname }} - Test configuration: {{ '‚úÖ OK' if config_test.rc == 0 else '‚ö†Ô∏è √âCHEC (code: ' ~ config_test.rc|string ~ ')' }}"
      tags: verification

    # PHASE 7: D√âMARRAGE DU SERVICE
    - name: D√©marrer et activer l'agent Wazuh
      systemd:
        name: wazuh-agent
        state: started
        enabled: yes
      tags: service

    # PHASE 8: V√âRIFICATION FINALE
    - name: V√©rifier le statut final du service
      block:
        - name: Obtenir le statut systemd
          systemd:
            name: wazuh-agent
          register: service_status
          ignore_errors: yes

        - name: Tester la connexion au manager
          shell: |
            timeout 3 bash -c 'echo > /dev/tcp/{{ wazuh_manager_ip }}/1514' 2>/dev/null && echo "CONNECT√â" || echo "NON_CONNECT√â"
          args:
            executable: /bin/bash
          register: connection_test
          changed_when: false
          ignore_errors: yes

        - name: Compter les processus Wazuh
          shell: |
            ps aux | grep -E '(wazuh-agentd|wazuh-syscheckd|wazuh-logcollector|wazuh-modulesd)' | grep -v grep | wc -l
          args:
            executable: /bin/bash
          register: process_count
          changed_when: false
          ignore_errors: yes

        - name: Afficher le r√©sultat final
          debug:
            msg: |
              üéØ {{ inventory_hostname }} - D√âPLOIEMENT TERMIN√â
              ‚úÖ Service: {{ service_status.status.ActiveState | default('inconnu') }}
              üîå Connexion: {{ connection_test.stdout | default('non_test√©e') }}
              üìä Processus Wazuh: {{ process_count.stdout | default('0') }}
              üè∑Ô∏è Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}
      tags: verification

    # PHASE 9: NETTOYAGE
    - name: Nettoyer les fichiers temporaires
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/wazuh-agent-*.deb"
        - "/tmp/wazuh-agent-*.rpm"
        - "/tmp/GPG-KEY-WAZUH"
      ignore_errors: yes
      tags: cleanup

    # PHASE 10: R√âSUM√â GLOBAL
    - name: R√©sum√© global du d√©ploiement
      debug:
        msg: |
          üìä R√âSUM√â DU D√âPLOIEMENT WAZUH
          ==============================
          Nombre total de machines: {{ groups['all'] | length }}
          Manager Wazuh: {{ wazuh_manager_ip }}
          Port: 1514 (TCP)

          Instructions:
          1. V√©rifiez l'interface: https://{{ wazuh_manager_ip }}
          2. Les agents devraient appara√Ætre dans quelques minutes
          3. V√©rifiez les logs: /var/ossec/logs/ossec.log

          üîç Pour v√©rifier manuellement:
          - systemctl status wazuh-agent
          - /var/ossec/bin/wazuh-agentd -t
          - tail -f /var/ossec/logs/ossec.log
      run_once: yes
      tags: summary
